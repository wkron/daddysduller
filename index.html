<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Fad√∏l Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3Eüç∫%3C/text%3E%3C/svg%3E">
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3Eüç∫%3C/text%3E%3C/svg%3E">
  <style>
    /* ==================== LAYOUT ==================== */
    #app {
      max-width: 360px;
      margin: 0 auto;
      padding: 1rem;
    }
    
    @media (min-width: 768px) {
      #app {
        max-width: 720px;
      }
    }

    /* ==================== BASE BUTTON NORMALIZATION ==================== */
    .btn {
      -webkit-appearance: none;
      appearance: none;

      background: none;
      border: none;
      padding: 0;
      margin: 0;

      font-family: inherit;
      font-size: inherit;
      color: inherit;

      cursor: pointer;
      text-align: center;

      -webkit-tap-highlight-color: transparent;
    }

    .btn:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }


    /* ==================== LANGUAGE SELECTOR ==================== */
    #language-selector {
      position: absolute;
      top: 1rem;
      right: 1rem;
      display: flex;
      gap: 0.5rem;
    }

    .flag-btn {
      font-size: 1.5rem;
      cursor: pointer;
      border: 2px solid transparent;
      background: none;
      padding: 0.2rem;
      border-radius: 4px;
      opacity: 0.6;
      transition: opacity 0.2s, border-color 0.2s;
    }

    .flag-btn:hover {
      opacity: 0.8;
    }

    .flag-btn.active {
      opacity: 1;
      border-color: #222;
    }

    /* ==================== NAME SELECTOR ==================== */
    #people {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 0.5rem;
      max-width: 300px;
      margin: 1rem auto;
    }

    .person-btn {
      padding: 0.6rem;
      font-size: 1rem;
      border: 2px solid #ddd;
      background: white;
      border-radius: 6px;
      color: #222;
    }

    
    .person-btn.active {
      background: #222;
      color: white;
      border-color: #222;
    }

    /* ==================== ADD BEER BUTTON ==================== */
    #add-beer-container {
      max-width: 300px;
      margin: 1.5rem auto;
    }

    #add-beer-btn {
      width: 100%;
      padding: 1rem;
      font-size: 1.4rem;
      font-weight: bold;
      border-radius: 12px;
      border: none;
      background: linear-gradient(135deg, #f6c453, #f09c2d);
      color: #222;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      transition: transform 0.05s ease, box-shadow 0.05s ease;
    }

    #add-beer-btn:active {
      transform: translateY(2px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    #add-beer-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* ==================== STREAK INDICATOR ==================== */
    #streak-container {
      max-width: 300px;
      margin: 1rem auto;
      padding: 0.75rem;
      background: linear-gradient(135deg, #8cc56f, #5ed364);
      color: white;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
      display: none;
    }

    #streak-container.show {
      display: block;
    }

    /* ==================== CHART ==================== */
    #chart-container {
      max-width: 300px;
      margin: 1rem auto;
      position: relative;
      height: 300px;
    }
    
    @media (min-width: 768px) {
      #chart-container {
        max-width: 1000px;
        height: 500px;
      }
    }

    /* ==================== CHART CONTROLS ==================== */
    #chart-controls {
      max-width: 300px;
      margin: 1rem auto;
      padding: 0.75rem;
      background: #f5f5f5;
      border-radius: 8px;
    }

    @media (min-width: 768px) {
      #chart-controls {
        max-width: 1000px;
      }
    }

    .control-group {
      margin-bottom: 0.75rem;
    }

    .control-group:last-child {
      margin-bottom: 0;
    }

    .control-group label {
      display: block;
      font-weight: normal;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }

    .toggle-btn {
      padding: 0.5rem 1rem;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
      border: 2px solid #ddd;
      background: white;
      border-radius: 6px;
      font-size: 0.9rem;
      color: #222;
    }


    .toggle-btn.active {
      background: #222;
      color: white;
      border-color: #222;
    }

    .person-toggle {
      display: inline-block;
    }

    /* ==================== RENAME MODAL ==================== */
    #rename-container {
      max-width: 300px;
      margin: 2rem auto;
      text-align: center;
    }

    #rename-btn {
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
      border: 1px solid #ccc;
      background: white;
      border-radius: 6px;
      cursor: pointer;
    }

    #rename-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    #rename-modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      max-width: 400px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .rename-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .rename-row label {
      flex: 0 0 80px;
      font-size: 0.9rem;
    }

    .rename-row input {
      flex: 1;
      padding: 0.4rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .modal-buttons {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .modal-buttons button {
      flex: 1;
      padding: 0.6rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.95rem;
    }

    .modal-buttons .save-btn {
      background: #222;
      color: white;
    }

    .modal-buttons .cancel-btn {
      background: #ddd;
      color: #222;
    }
  </style>
</head>
<body>
  <div id="language-selector">
    <button class="btn flag-btn active" onclick="setLanguage('da')" title="Dansk">üá©üá∞</button>
    <button class="btn flag-btn" onclick="setLanguage('en')" title="English">üá¨üáß</button>
    <button class="btn flag-btn" onclick="setLanguage('de')" title="Deutsch">üá©üá™</button>
    <button class="btn flag-btn" onclick="setLanguage('fr')" title="Fran√ßais">üá´üá∑</button>
  </div>

  <div id="app">
    <h1 data-i18n="title">üç∫ Fad√∏l Tracker</h1>

    <h3 data-i18n="selectName">V√¶lg navn</h3>
    <div id="people"></div>

    <div id="add-beer-container">
      <button id="add-beer-btn" onclick="addBeer()">
        <span data-i18n="addBeer">üç∫ +1 fad√∏l</span>
      </button>
    </div>

    <h2 style="margin-top: 2rem;">
      <span data-i18n="totalBeers">Total fad√∏l</span>: <span id="total">..‚è≥..</span>
    </h2>

    <div id="streak-container">
      <span id="streak-text"></span>
    </div>

    <h3 data-i18n="leaderboardTitle">üèÜ Leaderboard</h3>
    <ul id="leaderboard"></ul>

    <h3 data-i18n="chartTitle">üìà Fad√∏l over tid</h3>
    
    <div id="chart-container">
      <canvas id="beerChart"></canvas>
    </div>

    <div id="chart-controls">
      <div class="control-group">
        <button class="btn toggle-btn active" onclick="setChartType('cumulative')">
          <span data-i18n="cumulative">Kumulativ</span>
        </button>
        <button class="btn toggle-btn" onclick="setChartType('daily')">
          <span data-i18n="perDay">Per dag</span>
        </button>
      </div>
      
      <div class="control-group">
        <label data-i18n="showData">Vis data:</label>
        <button class="btn toggle-btn" id="show-total-btn" onclick="toggleTotal()">
          <span data-i18n="total">Total</span>
        </button>
        <div id="person-toggles" style="display: inline;"></div>
      </div>
    </div>

    <div id="rename-container">
      <button id="rename-btn" onclick="openRenameModal()">
        <span data-i18n="editNames">‚úèÔ∏è Rediger navne</span>
      </button>
    </div>

    <div id="rename-modal">
      <div class="modal-content">
        <h3 style="margin-top: 0;" data-i18n="editNames">Rediger navne</h3>
        <div id="rename-inputs"></div>
        <div class="modal-buttons">
          <button class="btn cancel-btn" onclick="closeRenameModal()">
            <span data-i18n="cancel">Annuller</span>
          </button>
          <button class="btn save-btn" onclick="saveRenames()">
            <span data-i18n="save">Gem</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // ==================== CONSTANTS ====================
    const API_URL = "https://script.google.com/macros/s/AKfycbxcRLqrkpSmbjjhscg0kJVNKzmgDhYZmhFW611biTZCNvIycpVac_7iAedzJQWMaU3e/exec";
    const CSV_URL = "https://docs.google.com/spreadsheets/d/1Nz0i7Q9p61VT15Ia4E5muW4npkYCniaKVtAWBzTnzP8/export?format=csv&gid=0";
    
    const PEOPLE = [
      "Augusta", "Baldur", "Frigg", "Julle", "Lise",
      "Malthe", "Milla", "Mille", "Nikolai", "William"
    ];

    const COLORS = [
      '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
      '#FF9F40', '#E74C3C', '#95A5A6', '#2ECC71', '#E67E22'
    ];

    // ==================== TRANSLATIONS ====================
    const translations = {
      da: {
        title: "üç∫ Fad√∏l Tracker",
        selectName: "V√¶lg navn",
        addBeer: "üç∫ +1 fad√∏l",
        totalBeers: "Total fad√∏l",
        leaderboardTitle: "üèÜ Leaderboard",
        chartTitle: "üìà Fad√∏l over tid",
        cumulative: "Kumulativ",
        perDay: "Per dag",
        showData: "Vis data:",
        total: "Total",
        editNames: "‚úèÔ∏è Rediger navne",
        cancel: "Annuller",
        save: "Gem",
        selectNameFirst: "V√¶lg dit navn f√∏rst üç∫",
        streak: "Streak! Der er blevet drukket fad√∏l {days} dage i tr√¶k üî•"
      },
      en: {
        title: "üç∫ Draft Beer Tracker",
        selectName: "Select name",
        addBeer: "üç∫ +1 beer",
        totalBeers: "Total beers",
        leaderboardTitle: "üèÜ Leaderboard",
        chartTitle: "üìà Beers over time",
        cumulative: "Cumulative",
        perDay: "Per day",
        showData: "Show data:",
        total: "Total",
        editNames: "‚úèÔ∏è Edit names",
        cancel: "Cancel",
        save: "Save",
        selectNameFirst: "Select your name first üç∫",
        streak: "Streak! Beers have been consumed for {days} days in a row üî•"
      },
      de: {
        title: "üç∫ Bier vom Fass Tracker",
        selectName: "Name w√§hlen",
        addBeer: "üç∫ +1 Bier",
        totalBeers: "Biere insgesamt",
        leaderboardTitle: "üèÜ Bestenliste",
        chartTitle: "üìà Biere √ºber Zeit",
        cumulative: "Kumulativ",
        perDay: "Pro Tag",
        showData: "Daten anzeigen:",
        total: "Gesamt",
        editNames: "‚úèÔ∏è Namen bearbeiten",
        cancel: "Abbrechen",
        save: "Speichern",
        selectNameFirst: "W√§hle zuerst deinen Namen üç∫",
        streak: "Serie! {days} Tage in Folge Bier getrunken üî•"
      },
      fr: {
        title: "üç∫ Tracker de Bi√®re Pression",
        selectName: "S√©lectionner un nom",
        addBeer: "üç∫ +1 bi√®re",
        totalBeers: "Bi√®res totales",
        leaderboardTitle: "üèÜ Classement",
        chartTitle: "üìà Bi√®res au fil du temps",
        cumulative: "Cumulatif",
        perDay: "Par jour",
        showData: "Afficher les donn√©es:",
        total: "Total",
        editNames: "‚úèÔ∏è Modifier les noms",
        cancel: "Annuler",
        save: "Enregistrer",
        selectNameFirst: "S√©lectionnez d'abord votre nom üç∫",
        streak: "S√©rie! Bi√®res consomm√©es pendant {days} jours cons√©cutifs üî•"
      }
    };

    // ==================== STATE ====================
    let state = {
      total: 0,
      chartType: 'cumulative',
      selectedPeople: new Set(),
      showTotal: false,
      rawData: [],
      displayNames: {},
      currentName: localStorage.getItem("name") || null,
      currentLanguage: localStorage.getItem("language") || 'da',
      chart: null
    };

    // ==================== INITIALIZATION ====================
    function init() {
      loadDisplayNames();
      setLanguage(state.currentLanguage);
      renderPeople();
      renderPersonToggles();
      updateFromServer();
    }

    // ==================== LANGUAGE FUNCTIONS ====================
    function setLanguage(lang) {
      state.currentLanguage = lang;
      localStorage.setItem("language", lang);
      
      // Update flag buttons
      document.querySelectorAll('.flag-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event?.target?.classList.add('active') || 
        document.querySelector(`[onclick="setLanguage('${lang}')"]`).classList.add('active');
      
      // Update all translatable elements
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (translations[lang][key]) {
          el.textContent = translations[lang][key];
        }
      });
      
      // Update streak if visible
      updateStreakDisplay();
    }

    function t(key, params = {}) {
      let text = translations[state.currentLanguage][key] || key;
      Object.keys(params).forEach(param => {
        text = text.replace(`{${param}}`, params[param]);
      });
      return text;
    }

    // ==================== DISPLAY NAME FUNCTIONS ====================
    function loadDisplayNames() {
      const saved = localStorage.getItem("displayNames");
      if (saved) {
        state.displayNames = JSON.parse(saved);
      } else {
        PEOPLE.forEach(name => {
          state.displayNames[name] = name;
        });
      }
    }

    function saveDisplayNames() {
      localStorage.setItem("displayNames", JSON.stringify(state.displayNames));
    }

    function getDisplayName(dbName) {
      return state.displayNames[dbName] || dbName;
    }

    // ==================== DATE FUNCTIONS ====================
    function parseDate(dateStr) {
      const datePart = dateStr.split(' ')[0];
      const [day, month, year] = datePart.split('/');
      return `${year}-${month}-${day}`;
    }

    function getAllDatesInRange(startDate, endDate) {
      const dates = [];
      const current = new Date(startDate + 'T00:00:00');
      const end = new Date(endDate + 'T00:00:00');
      
      while (current <= end) {
        const year = current.getFullYear();
        const month = String(current.getMonth() + 1).padStart(2, '0');
        const day = String(current.getDate()).padStart(2, '0');
        dates.push(`${year}-${month}-${day}`);
        current.setDate(current.getDate() + 1);
      }
      
      return dates;
    }

    // ==================== STREAK CALCULATION ====================
    function calculateStreak(data) {
      if (!data.length) return 0;
      
      const perDay = {};
      data.forEach(r => {
        const date = parseDate(r[0]);
        perDay[date] = (perDay[date] || 0) + Number(r[2]);
      });
      
      const sortedDays = Object.keys(perDay).sort().reverse();
      const today = new Date().toISOString().slice(0, 10);
      
      // Check if there's activity today or yesterday
      const lastDay = sortedDays[0];
      const lastDayDate = new Date(lastDay + 'T00:00:00');
      const todayDate = new Date(today + 'T00:00:00');
      const daysDiff = Math.floor((todayDate - lastDayDate) / (1000 * 60 * 60 * 24));
      
      if (daysDiff > 1) return 0; // Streak broken
      
      // Count consecutive days
      let streak = 1;
      for (let i = 1; i < sortedDays.length; i++) {
        const currentDate = new Date(sortedDays[i] + 'T00:00:00');
        const prevDate = new Date(sortedDays[i - 1] + 'T00:00:00');
        const diff = Math.floor((prevDate - currentDate) / (1000 * 60 * 60 * 24));
        
        if (diff === 1) {
          streak++;
        } else {
          break;
        }
      }
      
      return streak;
    }

    function updateStreakDisplay() {
      const streak = calculateStreak(state.rawData);
      const container = document.getElementById('streak-container');
      const textEl = document.getElementById('streak-text');
      
      if (streak >= 3) {
        textEl.textContent = t('streak', { days: streak });
        container.classList.add('show');
      } else {
        container.classList.remove('show');
      }
    }

    // ==================== RENDER FUNCTIONS ====================
    function renderPeople() {
      const peopleDiv = document.getElementById("people");
      peopleDiv.innerHTML = "";
      
      PEOPLE.forEach(name => {
        const btn = document.createElement("button");
        btn.textContent = getDisplayName(name);
        btn.className = "btn person-btn";
        if (name === state.currentName) {
          btn.classList.add("active");
        }
        btn.onclick = () => {
          state.currentName = name;
          localStorage.setItem("name", name);
          renderPeople();
        };
        peopleDiv.appendChild(btn);
      });
    }

    function renderPersonToggles() {
      const container = document.getElementById("person-toggles");
      container.innerHTML = "";
      
      PEOPLE.forEach(name => {
        const btn = document.createElement("button");
        btn.textContent = getDisplayName(name);
        btn.className = "toggle-btn person-toggle";
        if (state.selectedPeople.has(name)) {
          btn.classList.add("active");
        }
        btn.onclick = () => togglePerson(name);
        container.appendChild(btn);
      });
    }

    // ==================== UI ACTIONS ====================
    function togglePerson(name) {
      if (state.selectedPeople.has(name)) {
        state.selectedPeople.delete(name);
      } else {
        state.selectedPeople.add(name);
      }
      renderPersonToggles();
      updateChart();
    }

    function toggleTotal() {
      state.showTotal = !state.showTotal;
      const btn = document.getElementById('show-total-btn');
      if (state.showTotal) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
      updateChart();
    }

    function setChartType(type) {
      state.chartType = type;
      document.querySelectorAll('#chart-controls .control-group:first-child .toggle-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      updateChart();
    }

    // ==================== DATA FUNCTIONS ====================
    function parseCSV(text) {
      return text
        .trim()
        .split("\n")
        .slice(1)
        .map(row => row.split(","));
    }

    function updateFromServer() {
      fetch(CSV_URL)
        .then(r => r.text())
        .then(text => {
          state.rawData = parseCSV(text);
          
          // Update total
          const totalBeers = state.rawData.reduce((s, r) => s + Number(r[2]), 0);
          setTotal(totalBeers);
          
          // Update streak
          updateStreakDisplay();
          
          // Update leaderboard
          updateLeaderboard();
          
          // Update chart
          updateChart();
        });
    }

    function updateLeaderboard() {
      const perPerson = {};
      state.rawData.forEach(r => {
        const name = r[1];
        const beers = Number(r[2]);
        perPerson[name] = (perPerson[name] || 0) + beers;
      });

      const leaderboard = document.getElementById("leaderboard");
      leaderboard.innerHTML = "";
      const medals = ["ü•á", "ü•à", "ü•â"];
      
      Object.entries(perPerson)
        .sort((a, b) => b[1] - a[1])
        .forEach(([name, beers], i) => {
          const li = document.createElement("li");
          const medal = i < 3 ? medals[i] : "";
          li.textContent = `${medal} ${getDisplayName(name)}: ${beers}`;
          leaderboard.appendChild(li);
        });
    }

    function updateChart() {
      if (!state.rawData.length) return;

      let datasets = [];
      const chartTypeConfig = state.chartType === 'daily' ? 'bar' : 'line';

      // Get date range
      const observedDates = new Set();
      state.rawData.forEach(r => observedDates.add(parseDate(r[0])));
      const sortedObserved = Array.from(observedDates).sort();
      const startDate = sortedObserved[0];
      const endDate = sortedObserved[sortedObserved.length - 1];
      const allDays = getAllDatesInRange(startDate, endDate);

      // Add total dataset if toggled
      if (state.showTotal) {
        const perDay = {};
        state.rawData.forEach(r => {
          const date = parseDate(r[0]);
          perDay[date] = (perDay[date] || 0) + Number(r[2]);
        });

        if (state.chartType === 'cumulative') {
          let sum = 0;
          const cumulative = allDays.map(d => {
            sum += (perDay[d] || 0);
            return sum;
          });
          datasets.push({
            label: t('total'),
            data: cumulative,
            tension: 0.3,
            borderColor: '#000000',
            backgroundColor: 'transparent',
            borderWidth: 3
          });
        } else {
          datasets.push({
            label: t('total'),
            data: allDays.map(d => perDay[d] || 0),
            backgroundColor: '#000000'
          });
        }
      }

      // Add individual person datasets
      if (state.selectedPeople.size > 0) {
        state.selectedPeople.forEach((person) => {
          const perDay = {};
          state.rawData.forEach(r => {
            if (r[1] === person) {
              const date = parseDate(r[0]);
              perDay[date] = (perDay[date] || 0) + Number(r[2]);
            }
          });

          if (state.chartType === 'cumulative') {
            let sum = 0;
            const cumulative = allDays.map(d => {
              sum += (perDay[d] || 0);
              return sum;
            });
            datasets.push({
              label: getDisplayName(person),
              data: cumulative,
              tension: 0.3,
              borderColor: COLORS[PEOPLE.indexOf(person) % COLORS.length],
              backgroundColor: 'transparent'
            });
          } else {
            datasets.push({
              label: getDisplayName(person),
              data: allDays.map(d => perDay[d] || 0),
              backgroundColor: COLORS[PEOPLE.indexOf(person) % COLORS.length]
            });
          }
        });
      }

      // Default: show total if nothing selected
      if (!state.showTotal && state.selectedPeople.size === 0) {
        const perDay = {};
        state.rawData.forEach(r => {
          const date = parseDate(r[0]);
          perDay[date] = (perDay[date] || 0) + Number(r[2]);
        });

        if (state.chartType === 'cumulative') {
          let sum = 0;
          const cumulative = allDays.map(d => {
            sum += (perDay[d] || 0);
            return sum;
          });
          datasets.push({
            label: t('totalBeers'),
            data: cumulative,
            tension: 0.3,
            borderColor: '#36A2EB',
            backgroundColor: 'rgba(54, 162, 235, 0.2)'
          });
        } else {
          datasets.push({
            label: t('totalBeers'),
            data: allDays.map(d => perDay[d] || 0),
            backgroundColor: '#36A2EB'
          });
        }
      }

      if (state.chart) state.chart.destroy();
      state.chart = new Chart(document.getElementById("beerChart"), {
        type: chartTypeConfig,
        data: {
          labels: allDays,
          datasets: datasets
        },
        options: {
          maintainAspectRatio: false,
          responsive: true,
          scales: {
            y: {
              ticks: {
                precision: 0
              }
            },
            x: {
              ticks: {
                maxTicksLimit: 8,
                autoSkip: true,
                maxRotation: 45,
                minRotation: 45
              }
            }
          }
        }
      });
    }

    function setTotal(value) {
      state.total = value;
      document.getElementById("total").textContent = value;
    }

    function addBeer() {
      if (!state.currentName) {
        alert(t('selectNameFirst'));
        return;
      }
      
      setTotal(state.total + 1);

      fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({
          name: state.currentName,
          beers: 1
        })
      }).then(updateFromServer);
    }

    // ==================== RENAME MODAL ====================
    function openRenameModal() {
      const modal = document.getElementById("rename-modal");
      const container = document.getElementById("rename-inputs");
      container.innerHTML = "";
      
      PEOPLE.forEach(name => {
        const row = document.createElement("div");
        row.className = "rename-row";
        
        const label = document.createElement("label");
        label.textContent = name + ":";
        
        const input = document.createElement("input");
        input.type = "text";
        input.value = getDisplayName(name);
        input.dataset.dbName = name;
        
        row.appendChild(label);
        row.appendChild(input);
        container.appendChild(row);
      });
      
      modal.classList.add("show");
    }

    function closeRenameModal() {
      const modal = document.getElementById("rename-modal");
      modal.classList.remove("show");
    }

    function saveRenames() {
      const inputs = document.querySelectorAll("#rename-inputs input");
      inputs.forEach(input => {
        const dbName = input.dataset.dbName;
        const newDisplayName = input.value.trim() || dbName;
        state.displayNames[dbName] = newDisplayName;
      });
      
      saveDisplayNames();
      renderPeople();
      renderPersonToggles();
      updateFromServer();
      closeRenameModal();
    }

    // ==================== START APPLICATION ====================
    init();
  </script>
</body>
</html>