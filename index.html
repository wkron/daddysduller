<body>

  <h1>üç∫ Fad√∏l Tracker</h1>

  <div>
    <input id="name" placeholder="Dit navn">
  </div>

  <div style="margin-top: 1rem;">
    <button onclick="addBeer()">+1 fad√∏l</button>
  </div>

  <h2 style="margin-top: 2rem;">
    Total fad√∏l: <span id="total">..‚è≥..</span>
  </h2>

  <h3>üèÜ Leaderboard</h3>
  <ul id="leaderboard"></ul>

  <h3>üìà Fad√∏l over tid</h3>
  <canvas id="beerChart" width="400" height="200"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
  const API_URL = "https://script.google.com/macros/s/AKfycbxcRLqrkpSmbjjhscg0kJVNKzmgDhYZmhFW611biTZCNvIycpVac_7iAedzJQWMaU3e/exec";
  const CSV_URL = "https://docs.google.com/spreadsheets/d/1Nz0i7Q9p61VT15Ia4E5muW4npkYCniaKVtAWBzTnzP8/export?format=csv&gid=0"
    
  let total = 0;

  let chart; // global reference

  const savedName = localStorage.getItem("name");
  if (savedName) document.getElementById("name").value = savedName;
    
  function parseCSV(text) {
  return text
    .trim()
    .split("\n")
    .slice(1) // skip header
    .map(row => row.split(","));
  }
  
    
  function updateFromServer() {
  fetch(CSV_URL)
    .then(r => r.text())
    .then(text => {
      const rows = parseCSV(text);

      // TOTAL
      const total =
        rows.reduce((s, r) => s + Number(r[2]), 0);
      setTotal(total);

      // LEADERBOARD
      const perPerson = {};
      rows.forEach(r => {
        const name = r[1];
        const beers = Number(r[2]);
        perPerson[name] = (perPerson[name] || 0) + beers;
      });

      const leaderboard = document.getElementById("leaderboard");
      leaderboard.innerHTML = "";

      const medals = ["ü•á", "ü•à", "ü•â"];
        
      Object.entries(perPerson)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)              // top 5
        .forEach(([name, beers], i) => {
          const li = document.createElement("li");
          const medal = medals[i] || "";
          li.textContent = `${medal} ${name}: ${beers}`;
          leaderboard.appendChild(li);
      });


      // GRAF (kumulativ)
     const perDay = {};

      rows.forEach(r => {
        const date = r[0].slice(0, 10); // YYYY-MM-DD
        perDay[date] = (perDay[date] || 0) + Number(r[2]);
      });

      const days = Object.keys(perDay).sort();
      let sum = 0;
      const cumulative = days.map(d => {
        sum += perDay[d];
        return sum;
      });

      if (chart) chart.destroy();
      chart = new Chart(
        document.getElementById("beerChart"),
        {
          type: "line",
          data: {
            labels: days,
            datasets: [{
              label: "Total fad√∏l",
              data: cumulative,
              tension: 0.3
            }]
          }
        }
      );
    });
  }

  
  function setTotal(value) {
    total = value;
    document.getElementById("total").textContent = total;
  }


  function addBeer() {
    const name = nameInput.value.trim() || "Ukendt";
    localStorage.setItem("name", name);
    setTotal(total + 1); // optimistic UI

    fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({
        name: document.getElementById("name").value.trim() || "Ukendt",
        beers: 1
      })
    }).then(updateFromServer);
  }



  updateFromServer();


    
  </script>


</body>
